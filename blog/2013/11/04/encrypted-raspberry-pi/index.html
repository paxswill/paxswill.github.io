<!DOCTYPE html>
<html>
  <head>
    <title>Using an Encrypted Root Partition with&nbsp;Raspbian | Disaster Area</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="http://paxswill.com/theme/favicon.ico">
    <link rel="alternate" type="application/atom+xml" title="Disaster Area" href="http://paxswill.com/atom.xml">
    <link rel="alternate" type="application/rss+xml" title="Disaster Area" href="http://paxswill.com/rss.xml">
    <!-- Stylesheets -->
    <link rel="stylesheet" media="screen" href="http://paxswill.com/theme/css/bootstrap.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/css/style.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/css/pygments.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <header class="col-sm-offset-2 col-sm-8 col-md-offset-1 col-md-2">
          <h1><a href="http://paxswill.com/">Disaster Area</a><br class="visible-md visible-lg">
              <small>
                  <a href="mailto:paxswill@paxswill.com">
                    <i class="icon-envelope"></i>
                  </a>
                  <a href="https://github.com/paxswill">
                    <i class="icon-github-sign"></i>
                  </a>
                      <a href="http://paxswill.com/atom.xml">
                        <i class="icon-rss-sign"></i>
                      </a>
            </small>
          </h1>
        </header>
        <div class="clearfix hidden-md hidden-lg"></div>
        <div class="col-sm-2 hidden-md hidden-lg"></div>
        <div class="col-sm-8 col-md-6">
<article>
<h2>
  <a href="/blog/2013/11/04/encrypted-raspberry-pi/">Using an Encrypted Root Partition with&nbsp;Raspbian</a>
<small><time datetime="2013-11-04 00:00" pubdate>
  04 November 2013
</time>
</small></h2>

<p>I recently had to figure out how to encrypt the root partition of a Raspberry
Pi running Raspbian. I found some mentions of people doing it here and there,
but no end-to-end walkthrough of how to do it. These instructions are for
Raspbian &#8216;wheezy&#8217; and assume a newly imaged <span class="caps">SD</span> card from the distributed
Raspbian image. I also used another computer running Linux with an <span class="caps">SD</span> card
reader to perform the actual initial encryption. There may be a way of doing
this all form a single Pi, but I didn&#8217;t look to closely into&nbsp;it.</p>
<h2>Setup on the&nbsp;Pi</h2>
<p>First we make sure we&#8217;re using the latest software and then reboot to make sure
everything is there. After that you should expand the root partition by running
<code>sudo raspi-config</code> and following the&nbsp;prompts.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">update</span> <span class="o">&amp;&amp;</span> <span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">upgrade</span>
<span class="n">sudo</span> <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
</pre></div>


<p>Now we&#8217;ll upgrade the firmware and kernel. Right now (early November 2013) we
need to use the &#8216;next&#8217; branch as that kernel has <code>CONFIG_BLK_DEV_INITRD</code>
enabled. That option allows us to use an initial <span class="caps">RAM</span> filesystems (referred to
as an initramfs afterwards). This can take a while, and <em>will</em> fill up your
root partition if you haven&#8217;t expanded it yet. Afterwards reboot to have the
new firmware and kernel take&nbsp;effect.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n"><span class="caps">BRANCH</span></span><span class="o">=</span><span class="n">next</span> <span class="n">rpi</span><span class="o">-</span><span class="n">update</span>
<span class="n">sudo</span> <span class="n">shutdown</span> <span class="o">-</span><span class="n">r</span> <span class="n">now</span>
</pre></div>


<p>Now we install the necessary packages. Busybox is a collection of common shell
utilities and a shell that uses a very small memory footprint and will be our
shell in the initramfs. cryptsetup installs the necessary utilities to encrypt
and unlock encrypted&nbsp;partitions.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">busybox</span> <span class="n">cryptsetup</span>
</pre></div>


<p>Now we create the initramfs. On normal desktop distributions of Linux, this
step is usually run automatically whenever the kernel is update, but we have to
do it&nbsp;manually.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">mkinitramfs</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initramfs</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>Now we need to modify /boot/config.txt to have the bootloader load our new
initramfs into memory. Add these lines at the end of the&nbsp;file.</p>
<div class="highlight"><pre><span class="n">initramfs</span> <span class="n">initramfs</span><span class="p">.</span><span class="n">gz</span> <span class="n">followkernel</span>
</pre></div>


<h2>Encrypting the Root&nbsp;Partition.</h2>
<p>On another computer running Linux, mount the <span class="caps">SD</span> card. I&#8217;m using a Dell Mini 9,
and coincidentally the <span class="caps">SD</span> card reader uses <code>/dev/mmcblk0</code> like the Pi does.
Your device name may vary, checking dmesg with <code>dmesg | tail</code> may be useful to
learn what name your system uses for <span class="caps">SD</span> cards. Now create an image of the root
partition on the <span class="caps">SD</span> card (partition 2). Make sure the file system is alright,
then shrink it down to its minimum size. We&#8217;ll use this later to restore the
existing system to the new, encrypted&nbsp;partition.</p>
<div class="highlight"><pre><span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span> <span class="n">of</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">raspbian</span><span class="o">-</span><span class="n">plain</span><span class="p">.</span><span class="n">img</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="n">M</span>
<span class="n">e2fsck</span> <span class="o">-</span><span class="n">f</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">raspbian</span><span class="o">-</span><span class="n">plain</span><span class="p">.</span><span class="n">img</span>
<span class="n">resize2fs</span> <span class="o">-</span><span class="n">M</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">raspbian</span><span class="o">-</span><span class="n">plain</span><span class="p">.</span><span class="n">img</span>
</pre></div>


<p>If your non-Pi Linux computer doesn&#8217;t already have them installed, install the
cryptsetup&nbsp;command.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">cryptsetup</span>
</pre></div>


<p>Now we&#8217;re going to create the encrypted partition. You should explicitly
specify the key size and cipher as the default changed in version 1.6.0 os
cryptsetup and Raspbian has an older version that doesn&#8217;t support the new
cipher. The luksOpen command creates <code>/dev/mapper/sdcard</code>, which is the
decrypted interface to the encrypted&nbsp;partition.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">cryptsetup</span> <span class="o">-</span><span class="n">v</span> <span class="o">-</span><span class="n">y</span> <span class="o">--</span><span class="n">cipher</span> <span class="n">aes</span><span class="o">-</span><span class="n">cbc</span><span class="o">-</span><span class="n">essiv</span><span class="o">:</span><span class="n">sha256</span> <span class="o">--</span><span class="n">key</span><span class="o">-</span><span class="n">size</span> <span class="mi">256</span> <span class="n">luksFormat</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span>
<span class="n">sudo</span> <span class="n">cryptsetup</span> <span class="o">-</span><span class="n">v</span> <span class="n">luksOpen</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span> <span class="n">sdcard</span>
</pre></div>


<p>Now copy the original filesystem data back to the newly created encrypted
partition. This can sometimes take a while; it took just under ten minutes to
copy 3.<span class="caps">5GB</span> with my setup. After that we&#8217;ll re-expand the filesystem to take up
the whole&nbsp;partition.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">dd</span> <span class="k">if</span><span class="o">=/</span><span class="n">tmp</span><span class="o">/</span><span class="n">raspbian</span><span class="o">-</span><span class="n">plain</span><span class="p">.</span><span class="n">img</span> <span class="n">of</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">sdcard</span> <span class="n">bs</span><span class="o">=</span><span class="mi">4</span><span class="n">M</span>
<span class="n">sudo</span> <span class="n">e2fsck</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">sdcard</span>
<span class="n">sudo</span> <span class="n">resize2fs</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">sdcard</span>
</pre></div>


<p>Now we need to configure the system on the <span class="caps">SD</span> card to use the new partition
as its root. Change the <code>root=/dev/mmcblk0p2</code> part to
<code>root=/dev/mapper/sdcard</code> and add <code>cryptdevice=/dev/mmcblk0p2:sdcard</code>. We also
need to change /etc/fstab on to use the new encrypted partition. The commands
below will show you how to make the boot and main partition available. In the
fstab file, change <code>/dev/mmcblk0p2</code> to <code>/dev/mapper/sdcard</code>.</p>
<p>The last steps are to tell the Pi how to boot the new partition. First mount
the boot partition and the new partition somewhere so we can access them&nbsp;easily.</p>
<div class="highlight"><pre><span class="n">mkdir</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_root</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_boot</span>
<span class="n">sudo</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p1</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_boot</span>
<span class="n">sudo</span> <span class="n">mount</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">sdcard</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_root</span>
</pre></div>


<p>Now edit the cmdline.txt file on the Pi&#8217;s boot partition
(<code>/tmp/pi_boot/cmdline.txt</code> is you used the above commands) to tell the kernel
what the new root partition is and how to access it. Change
<code>root=/dev/mmcblk0p2</code> to <code>root=/dev/mapper/sdcard</code> and add
<code>cryptdevice=/dev/mmcblk0p2:sdcard</code>. Here&#8217;s what mine looks like after those
changes. Yours might be a little different, but it should look&nbsp;similar.</p>
<div class="highlight"><pre><span class="n">dwc_otg</span><span class="p">.</span><span class="n">lpm_enable</span><span class="o">=</span><span class="mi">0</span> <span class="n">console</span><span class="o">=</span><span class="n">ttyAMA0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">kgdboc</span><span class="o">=</span><span class="n">ttyAMA0</span><span class="p">,</span><span class="mi">115200</span> <span class="n">console</span><span class="o">=</span><span class="n">tty1</span> <span class="n">root</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mapper</span><span class="o">/</span><span class="n">sdcard</span> <span class="n">cryptdevice</span><span class="o">=/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span><span class="o">:</span><span class="n">sdcard</span> <span class="n">rootfstype</span><span class="o">=</span><span class="n">ext4</span> <span class="n">elevator</span><span class="o">=</span><span class="n">deadline</span> <span class="n">rootwait</span> <span class="n">smsc95xx</span><span class="p">.</span><span class="n">turbo_mode</span><span class="o">=</span><span class="n">N</span>
</pre></div>


<p>Now we need to tell the rest of the system on the Pi about the new partition.
Open up the fstab file on the Pi&#8217;s root partition (<code>/tmp/pi_root/etc/fstab</code>)
and change <code>/dev/mmcblk0p2</code> to <code>/dev/mapper/sdcard</code>. Now create a crypttab file
(<code>/tmp/pi_root/etc/crypttab</code>) and add this line at the end. Note that those are
tab characters seprarating each word, not&nbsp;spaces.</p>
<div class="highlight"><pre><span class="n">sdcard</span>  <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span>  <span class="n">none</span>    <span class="n">luks</span>
</pre></div>


<p>Now unmount everything and put the <span class="caps">SD</span> card back in your&nbsp;Pi.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">umount</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_boot</span> <span class="o">/</span><span class="n">tmp</span><span class="o">/</span><span class="n">pi_root</span>
<span class="n">sudo</span> <span class="n">cryptsetup</span> <span class="n">luksClose</span> <span class="n">sdcard</span>
</pre></div>


<h2>First&nbsp;Boot</h2>
<p><strong>The first boot will fail.</strong> Have a <span class="caps">USB</span> keyboard and a screen hooked up to
your Pi so you can work with the Busybox recovery shell. All you have to do is
mount the root partition and then exit the shell, and everything else will take
care of itself. Run these commands when you get an <code>(initramfs)</code> prompt.</p>
<div class="highlight"><pre><span class="n">cryptsetup</span> <span class="n">luksOpen</span> <span class="o">/</span><span class="n">dev</span><span class="o">/</span><span class="n">mmcblk0p2</span> <span class="n">sdcard</span>
<span class="n">exit</span>
</pre></div>


<p>Once the Pi is booted up the rest of the way, you need to re-create the
initramfs so you get a nicer unlock prompt on future start&nbsp;ups.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">mkinitramfs</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initramfs</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>You can now reboot. Instead of errors about not being able to find or mount the
root partition, you should get a nice prompt asking for your unlock password.
Enter it and press return, and the rest of the boot process should&nbsp;follow.</p>
<h3>Time&nbsp;Problem</h3>
<p>I found sometimes that mounting the decrypted root partition would fail because
the last unmount time was far in the future. This is because the Pi can&#8217;t save
the time between reboots like most other computers. To work around this, you can
use the <code>date</code> command to set the time in the initramfs, and then mount the system.
<code>date</code> takes the current time in MMDDhhmmYYYY, so November 4, 2013 at 13:30
would be 110413302013. To get to a shell to set the time, intentionally
cause the unlock script to exit by entering an incorrect password three times.
You&#8217;ll then have to wait about 30 seconds for a timeout, and then you&#8217;ll be at
the <code>(initramfs)</code> prompt. Set the time to something reasonably close (as long
as it&#8217;s within a day, you&#8217;re good) and then restart the unlocking&nbsp;script.</p>
<div class="highlight"><pre><span class="n">date</span> <span class="mi">110413302013</span>
<span class="o">/</span><span class="n">scripts</span><span class="o">/</span><span class="n">local</span><span class="o">-</span><span class="n">top</span><span class="o">/</span><span class="n">cryptroot</span>
</pre></div>


<h2>Remote&nbsp;Unlocking</h2>
<p>Having to be physically at the Pi to unlock the disk can be a pain, but there
is a way of unlocking it over <span class="caps">SSH</span>. The Dropbear <span class="caps">SSH</span> server is a very
small and lightweight server that can be run from the initramfs. It will
automatically add itself to the initramfs if it detects an encrypted partition
on the&nbsp;system.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">apt</span><span class="o">-</span><span class="n">get</span> <span class="n">install</span> <span class="n">dropbear</span>
</pre></div>


<p>There&#8217;s a minor bug in the initramfs scripts shipping with Dropbear in
Raspbian. On line 296 of
<code>/usr/share/initramfs-tools/scripts/local-top/cryptroot</code>, add <code>/sbin/</code>
just before <code>blkid</code>. It should look like this&nbsp;afterwards:</p>
<div class="highlight"><pre><span class="n"><span class="caps">FSTYPE</span></span><span class="o">=</span><span class="s">&quot;$(/sbin/blkid -s <span class="caps">TYPE</span> -o value &quot;</span><span class="err">$</span><span class="n"><span class="caps">NEWROOT</span></span><span class="s">&quot;)&quot;</span>
</pre></div>


<p>You have to re-create the initramfs again to trigger Dropbear to generate <span class="caps">SSH</span>&nbsp;keys.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">mkinitramfs</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initramfs</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>Now copy over the <span class="caps">SSH</span> key Dropbear generates (this is from the Pi, to another&nbsp;computer).</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">scp</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa</span> <span class="n">username</span><span class="err">@</span><span class="n">othercomputer</span><span class="o">:~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa_rpi_dropbear</span>
</pre></div>


<p>Finally, edit initramfs&#8217; authorized_keys file to have Dropbear show you the
password prompt as soon as you&nbsp;connect.</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">nano</span> <span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">initramfs</span><span class="o">-</span><span class="n">tools</span><span class="o">/</span><span class="n">root</span><span class="o">/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">authorized_keys</span>
</pre></div>


<p>Add this chunk of text just before the <code>ssh-rsa</code> at the beginning of the file.
This starts the unlock script, and once it has exited it stops the other
instance of the unlock script so boot can&nbsp;continue.</p>
<div class="highlight"><pre><span class="n">command</span><span class="o">=</span><span class="s">&quot;/scripts/local-top/cryptroot &amp;&amp; kill -9 `ps | grep -m 1 &#39;cryptroot&#39; | cut -d &#39; &#39; -f 3`&quot;</span>
</pre></div>


<p>And finally, rebuild initramfs for the last time (until you upgrade your&nbsp;kernel).</p>
<div class="highlight"><pre><span class="n">sudo</span> <span class="n">mkinitramfs</span> <span class="o">-</span><span class="n">o</span> <span class="o">/</span><span class="n">boot</span><span class="o">/</span><span class="n">initramfs</span><span class="p">.</span><span class="n">gz</span>
</pre></div>


<p>To test it out, restart your Pi, and then try logging in from another computer
(this step is from another computer that has network access to the&nbsp;Pi).</p>
<div class="highlight"><pre><span class="n">ssh</span> <span class="o">-</span><span class="n">i</span> <span class="o">~/</span><span class="p">.</span><span class="n">ssh</span><span class="o">/</span><span class="n">id_rsa_rpi_dropbear</span> <span class="n">root</span><span class="err">@</span><span class="mf">192.168.2.143</span>
</pre></div>


<p>You should be asked to enter a password, and once a correct one has been
entered the Pi will boot the rest of the&nbsp;way.</p>
<h2>Conclusions</h2>
<p>Write speed is greatly reduced, down to 4.2 <span class="caps">MB</span>/s from 12.9 <span class="caps">MB</span>/sec.
Writing a continued chunk of data to the <span class="caps">SD</span> card also pegs the <span class="caps">CPU</span> at 100%.
This results in a noticably slower startup and significant delays when
something is being written to disk. This might improve if <span class="caps">AES</span>-<span class="caps">XTS</span> support is
enabled in the Pi&#8217;s kernel and cryptsetup is updated to use it, but I&#8217;m not
confident the improvement will be that&nbsp;substantial.</p>
</article>

        </div>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-offset-3 col-md-3">
            <ul>
                <li><a href="/tutorials">Tutorials</a></li>
                <li><a href="/archives">Archives</a></li>
            </ul>
          </div>
          <div class="col-md-3">
            <p>&copy; Will Ross 2008&ndash;2013
</p>
          </div>
        </div>
      </div>
    </footer>
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="theme/js/bootstrap.min.js"></script>
  </body>
</html>