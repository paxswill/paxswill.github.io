<!DOCTYPE html>
<html>
  <head>
    <title>Disaster Area</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="shortcut icon" href="http://paxswill.com/theme/favicon.ico">
    <link rel="alternate" type="application/atom+xml" title="Disaster Area" href="http://paxswill.com/atom.xml">
    <link rel="alternate" type="application/rss+xml" title="Disaster Area" href="http://paxswill.com/rss.xml">
    <!-- Stylesheets -->
    <link rel="stylesheet" media="screen" href="http://paxswill.com/theme/css/bootstrap.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/font-awesome/css/font-awesome.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/css/style.css">
    <link rel="stylesheet" href="http://paxswill.com/theme/css/pygments.css">
  </head>
  <body>
    <div class="container">
      <div class="row">
        <header class="col-sm-offset-2 col-sm-8 col-md-offset-1 col-md-2">
          <h1><a href="http://paxswill.com/">Disaster Area</a><br class="visible-md visible-lg">
              <small>
                  <a href="mailto:paxswill@paxswill.com">
                    <i class="icon-envelope"></i>
                  </a>
                  <a href="https://github.com/paxswill">
                    <i class="icon-github-sign"></i>
                  </a>
                      <a href="http://paxswill.com/atom.xml">
                        <i class="icon-rss-sign"></i>
                      </a>
            </small>
          </h1>
        </header>
        <div class="clearfix hidden-md hidden-lg"></div>
        <div class="col-sm-2 hidden-md hidden-lg"></div>
        <div class="col-sm-8 col-md-6">
  <article>
<h2>
  <a href="/blog/2011/08/14/nsstring-cons/">NSString&nbsp;Cons</a>
<small><time datetime="2011-08-14 06:54" pubdate>
  14 August 2011
</time>
</small></h2>

<p>One of the fundamental operators in functional languages is &#8216;cons&#8217;. It
concatenates lists of things together, and since strings are usually treated as
lists of characters, cons gets a lot of use in string processing as well. One
of the cool tricks I saw done with Objective-C a while ago was implementing
cons on NSString, using <code>:</code> like Haskell and <span class="caps">ML</span> do. I have been unable to find
the original site, so I decided to reimplement it myself&nbsp;recently.</p>
<!--more-->

<p>A quick caveat to the following: this uses Objective-C trickery that may not be
very safe in a production environment. Also, the upcoming Automatic Reference
Counting in Clang/<span class="caps">LLVM</span> 3.0 will not compile this code. With that out of the
way, lets look at how we&#8217;re going to do this. In Objective-C, methods are
backed by a concrete implementation in the form of a standard C function. The
runtime uses the <a href="http://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html#//apple_ref/doc/uid/TP40001418-CH3g-BAJFGBJF"><code>IMP</code></a> type for this, which is defined&nbsp;as</p>
<div class="highlight"><pre><span class="kt">id</span> <span class="p">(</span><span class="o">*</span><span class="kt"><span class="caps">IMP</span></span><span class="p">)(</span><span class="kt">id</span> <span class="n">self</span><span class="p">,</span> <span class="kt"><span class="caps">SEL</span></span> <span class="n">selector</span><span class="p">,</span> <span class="p">...)</span>
</pre></div>


<p>The <code>...</code> in this case stands for additional arguments for the method. For
example, <code>[@"foo" stringByAppendingString:@"bar"]</code> will eventually be executed
by a function matching the prototype&nbsp;below.</p>
<div class="highlight"><pre><span class="kt">id</span> <span class="n">functionName</span><span class="p">(</span><span class="kt">id</span> <span class="n">self</span><span class="p">,</span> <span class="kt"><span class="caps">SEL</span></span> <span class="n">sel</span><span class="p">,</span> <span class="n">NSString</span> <span class="o">*</span><span class="n">otherString</span><span class="p">)</span>
</pre></div>


<p>Additional arguments are just tacked onto the end. This can be combined with
standard C varargs. The only caveat is we need to signal the end of the varargs
somehow. I used <code>nil</code>.</p>
<div class="highlight"><pre><span class="kt">id</span> <span class="nf">stringCons</span><span class="p">(</span><span class="kt">id</span> <span class="n">self</span><span class="p">,</span> <span class="kt"><span class="caps">SEL</span></span> <span class="n">selector</span><span class="p">,</span> <span class="p">...){</span>
    <span class="kt">va_list</span> <span class="n">strings</span><span class="p">;</span>
    <span class="n">NSMutableString</span> <span class="o">*</span><span class="n">fullString</span> <span class="o">=</span> <span class="p">[[</span><span class="n">NSMutableString</span> <span class="n">alloc</span><span class="p">]</span> <span class="n">initWithString</span><span class="o">:</span><span class="n">self</span><span class="p">];</span>
    <span class="n">va_start</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="n">selector</span><span class="p">);</span>
    <span class="kt">id</span> <span class="n">currentString</span> <span class="o">=</span> <span class="nb">nil</span><span class="p">;</span>
    <span class="c1">// End on nil</span>
    <span class="k">while</span><span class="p">((</span><span class="n">currentString</span> <span class="o">=</span> <span class="n">va_arg</span><span class="p">(</span><span class="n">strings</span><span class="p">,</span> <span class="kt">id</span><span class="p">))){</span>
        <span class="p">[</span><span class="n">fullString</span> <span class="n">appendString</span><span class="o">:</span><span class="n">currentString</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="n">va_end</span><span class="p">(</span><span class="n">strings</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">fullString</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>There are two approaches to adding a method to a class at runtime in
Objective-C. The  normal way is to use
<a href="http://developer.apple.com/library/mac/documentation/Cocoa/Reference/ObjCRuntimeRef/Reference/reference.html#//apple_ref/c/func/class_addMethod"><code>class_addMethod</code></a>. This is enough in most cases, but because
we have a variable length selector, we can&#8217;t use this method. Another way
methods can be added is with the dynamic method resolution available through
NSObject (Mike Ash touches on this method in a post on
<a href="http://mikeash.com/pyblog/friday-qa-2009-03-27-objective-c-message-forwarding.html">message forwarding</a>).</p>
<div class="highlight"><pre><span class="k">+</span><span class="p">(</span><span class="kt"><span class="caps">BOOL</span></span><span class="p">)</span><span class="nf">resolveInstanceMethod:</span><span class="p">(</span><span class="kt"><span class="caps">SEL</span></span><span class="p">)</span><span class="nv">sel</span><span class="p">{</span>
    <span class="c1">// Check that the selector is just &#39;:&#39; characters</span>
    <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">checkName</span> <span class="o">=</span> <span class="n">sel_getName</span><span class="p">(</span><span class="n">sel</span><span class="p">);</span>
    <span class="kt"><span class="caps">BOOL</span></span> <span class="n">isCons</span> <span class="o">=</span> <span class="nb"><span class="caps">YES</span></span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">c</span> <span class="o">=</span> <span class="n">checkName</span><span class="p">[</span><span class="n">i</span><span class="p">];</span>
    <span class="k">while</span><span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;\0&#39;</span><span class="p">){</span>
        <span class="k">if</span><span class="p">(</span><span class="n">c</span> <span class="o">!=</span> <span class="sc">&#39;:&#39;</span><span class="p">){</span>
            <span class="n">isCons</span> <span class="o">=</span> <span class="nb"><span class="caps">NO</span></span><span class="p">;</span>
            <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">c</span> <span class="o">=</span> <span class="n">checkName</span><span class="p">[</span><span class="o">++</span><span class="n">i</span><span class="p">];</span>
    <span class="p">}</span>
    <span class="c1">// Add the method, or pass this message up the chain</span>
    <span class="k">if</span><span class="p">(</span><span class="n">isCons</span><span class="p">){</span>
        <span class="c1">// Make the type string</span>
        <span class="kt">size_t</span> <span class="n">typesSize</span> <span class="o">=</span> <span class="mi">4</span> <span class="o">+</span> <span class="n">i</span><span class="p">;</span>
        <span class="kt">char</span> <span class="o">*</span><span class="n">types</span> <span class="o">=</span> <span class="n">malloc</span><span class="p">(</span><span class="k">sizeof</span><span class="p">(</span><span class="kt">char</span><span class="p">)</span> <span class="o">*</span> <span class="n">typesSize</span><span class="p">);</span>
        <span class="n">types</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
        <span class="n">types</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
        <span class="n">types</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;:&#39;</span><span class="p">;</span>
        <span class="k">for</span><span class="p">(</span><span class="kt">int</span> <span class="n">j</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span> <span class="n">j</span> <span class="o">&lt;</span> <span class="n">typesSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span> <span class="o">++</span><span class="n">j</span><span class="p">){</span>
            <span class="n">types</span><span class="p">[</span><span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;@&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">types</span><span class="p">[</span><span class="n">typesSize</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="sc">&#39;\0&#39;</span><span class="p">;</span>
        <span class="c1">// Add the method</span>
        <span class="n">class_addMethod</span><span class="p">([</span><span class="n">self</span> <span class="n">class</span><span class="p">],</span> <span class="n">sel</span><span class="p">,</span> <span class="n">stringCons</span><span class="p">,</span> <span class="n">types</span><span class="p">);</span>
        <span class="k">return</span> <span class="nb"><span class="caps">YES</span></span><span class="p">;</span>
    <span class="p">}</span><span class="k">else</span><span class="p">{</span>
        <span class="k">return</span> <span class="p">[</span><span class="n">super</span> <span class="n">resolveInstanceMethod</span><span class="o">:</span><span class="n">sel</span><span class="p">];</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>Here all were doing is checking to see if the selector is completely made up
of &#8216;:&#8217; characters. If it is, we add the <code>stringCons</code> <span class="caps">IMP</span> from above for that
selector. Note the else block at the end. The call to
<code>[super resolveInstanceMethod:sel]</code> is very important, as other parts of a
class may depend on this dynamic method&nbsp;resolution.</p>
<p>The final hurdle is how to add <code>+resolveInstanceMethod:</code> to NSString. The
safest way would be to subclass NSString, but since NSString is a class cluster
this is not possible. I ended up using a category, but a safer choice might be
to use method swizzling to insert our method in addition to any NSString may
have&nbsp;defined.</p>
<p>That&#8217;s it to adding a cons-like operator to NSString in Objective-C. To use it,
just insert it between instances of NSString ending with <code>nil</code>, like&nbsp;below.</p>
<div class="highlight"><pre><span class="n">NSString</span> <span class="o">*</span><span class="n">one</span> <span class="o">=</span> <span class="s">@&quot;1&quot;</span><span class="p">;</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">two</span> <span class="o">=</span> <span class="s">@&quot;2&quot;</span><span class="p">;</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">three</span> <span class="o">=</span> <span class="s">@&quot;3&quot;</span><span class="p">;</span>
<span class="n">NSString</span> <span class="o">*</span><span class="n">all</span> <span class="o">=</span> <span class="p">[</span><span class="n">one</span><span class="o">:</span><span class="n">two</span><span class="o">:</span><span class="n">three</span><span class="o">:</span><span class="nb">nil</span><span class="p">];</span>
</pre></div>
</article>

    <hr>
  <article>
<h2>
  <a href="/blog/2011/03/28/cwavelet-weekend/">cWavelet</a>
<small><time datetime="2011-03-28 00:00" pubdate>
  28 March 2011
</time>
</small></h2>

<p>Weekend project I made: <a href="https://github.com/paxswill/cwavelet">cWavelet</a>.</p>
<p>It&#8217;s a simple wavelet library written in pure C. I&#8217;ve been trying to wrap
 my head around wavelets off and on for about three months, and I finally 
got them enough to write a library. It is still being developed, but it does
 simple forward transforms (as far as I can tell correctly) right now. In the 
future, I hope to implement portions of it in OpenCL and/or <span class="caps">MPI</span> so I can
 try it out on the clusters at&nbsp;school.</p>
</article>

    <hr>
  <article>
<h2>
  <a href="/blog/2010/05/01/ubuntu-1004-dell-mini-9/">Ubuntu 10.04 on a Dell Mini&nbsp;9</a>
<small><time datetime="2010-05-01 00:00" pubdate>
  01 May 2010
</time>
</small></h2>

<p>The Mac <span class="caps">OS</span> X install on my Mini 9 was recently borked (friend was borrowing it,
and an unclean shutdown corrupted the file system), and I didn&#8217;t have the
install discs on me. I&#8217;d also been messing with the Lucid Lynx beta in a <span class="caps">VM</span> on
my machine, and was very impressed with the level of polish, so I decided to
install Ubuntu on the Mini again and see how it went.
<!--more-->
This was a couple days before the release date, so I downloaded the release
candidate and ran from there. I&#8217;ve used both the normal desktop and netbook
remix in previous versions of Ubuntu, and for my workflow I prefer using the 
normal desktop. As there isn&#8217;t a desktop .img available, I downloaded the
desktop <span class="caps">ISO</span> and used the <span class="caps">USB</span> IMage Writer in my <span class="caps">VM</span> to copy the <span class="caps">ISO</span> to a flash
drive. Installation had a minor hitch in that the first install didn&#8217;t seem to 
take, in that after the installer was finished and the system rebooted, nothing
showed up. I booted to the <span class="caps">USB</span> stick again, reinstalled, and everything worked 
after&nbsp;that.</p>
<p>Hardware support is very much improved in this version (I&#8217;ve previously used
8.04 and 9.04). I didn&#8217;t have to make any configuration changes to use sound
hardware, Bluetooth 
worked right away, 3D acceleration was a given as I have an Intel <span class="caps">GPU</span>, and
after I installed the Broadcom <span class="caps">STA</span> driver through the restricted driver 
installer, Wifi worked as well. Sleep works as well as it did under 9.10, as
having an <span class="caps">SD</span> card mounted when you try sleeping causes the suspend process to
hang. The fix is detailed in <a href="http://www.mydellmini.com/forum/ubuntu-netbook-remix/14722-suspend-hibernate-mini-9-broken-3.html#post143677">this</a> MyDellMini forum post. Reproduced
here, the fix is to add a hook to the sleep process that unmounts all memory
cards. Put the following script in the <code>/etc/pm/sleep.d/</code> directory.  </p>
<div class="highlight"><pre><span class="c">#!/bin/bash</span>

<span class="k">case</span> <span class="nv">$1</span> in
hibernate|suspend<span class="o">)</span>
umount /dev/mmcblk*
    ;;
<span class="c">#    thaw|resume)</span>
<span class="c">#        ;;</span>
*<span class="o">)</span>  <span class="nb">echo</span> <span class="nv">$1</span>
    ;;
<span class="k">esac</span>
<span class="nb">exit </span>0
</pre></div>


<p>Then make it&nbsp;executable.</p>
<p>Addendum: Turned out it wasn&#8217;t a bout of file system madness, it was the <span class="caps">SSD</span> dying.
 I sent it into Dell and got it back a week and a half&nbsp;later.</p>
</article>


<ul class="pagination">
    <li><a href="http://paxswill.com/index.html">&laquo</a>
</li>
    <li>
      <a href="http://paxswill.com/index.html">1</a>
    </li>
    <li class="active">
      <a href="http://paxswill.com/index2.html">2</a>
    </li>
    <li>
      <a href="http://paxswill.com/index3.html">3</a>
    </li>
    <li><a href="http://paxswill.com/index3.html">&raquo</a></li>
</ul>        </div>
      </div>
    </div>
    <footer>
      <div class="container">
        <div class="row">
          <div class="col-md-offset-3 col-md-3">
            <ul>
                <li><a href="/tutorials">Tutorials</a></li>
                <li><a href="/archives">Archives</a></li>
            </ul>
          </div>
          <div class="col-md-3">
            <p>&copy; Will Ross 2008&ndash;2013
</p>
          </div>
        </div>
      </div>
    </footer>
    <script src="//code.jquery.com/jquery.js"></script>
    <script src="theme/js/bootstrap.min.js"></script>
  </body>
</html>